<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>create topic - infiniware</title>
    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
  </head>

  <body>
    <header class="header">
      <div class="nav-brand">
        <a href="index.html" class="logo-text"><span>I</span>nfiniware</a>
      </div>
      <div class="nav-extras">
        <button class="theme-toggle-btn" aria-label="toggle theme"></button>
        <button class="mobile-menu-btn">☰</button>
      </div>
      <nav>
        <div class="nav-links">
          <a href="dashboard.html" class="nav-link">dashboard</a>
          <a href="#" class="nav-link" id="logout-btn">sign out</a>
        </div>
      </nav>
    </header>

    <div class="container" style="max-width: 800px; margin-top: 40px">
      <div class="card">
        <h2 class="mb-lg">create new topic</h2>

        <form id="create-topic-form" class="flex-col gap-md">
          <div class="input-group">
            <label class="input-label">category</label>
            <select id="category-select" class="input-field" required>
              <option value="">select a category...</option>
              <!-- Categories injected here -->
            </select>
          </div>

          <div class="input-group">
            <label class="input-label">topic title</label>
            <input
              type="text"
              id="topic-title"
              class="input-field"
              placeholder="enter a clear, descriptive title"
              required
              maxlength="200"
            />
          </div>

          <div class="input-group">
            <label class="input-label">initial post content</label>
            <textarea
              id="post-content"
              class="input-field"
              rows="12"
              placeholder="write your post here... markdown supported (code blocks, links, bold, italic)"
              required
            ></textarea>
            <p class="text-dim" style="font-size: 0.8rem; margin-top: 8px">
              supports: **bold**, *italic*, `code`, ```code blocks```, [links](url)
            </p>
          </div>

          <div class="input-group">
            <label class="input-label">attach images (optional, max 5MB each)</label>
            <input type="file" id="image-input" class="input-field" accept="image/*" multiple />
            <div id="image-preview-container" class="mt-md" style="display: none">
              <div
                id="image-previews"
                class="flex gap-md"
                style="flex-wrap: wrap; margin-top: 10px"
              ></div>
            </div>
          </div>

          <div class="flex gap-md align-center">
            <button type="submit" class="btn btn-red" id="submit-btn">create topic</button>
            <a href="dashboard.html" class="btn btn-ghost">cancel</a>
          </div>

          <p id="error-msg" class="text-red" style="display: none; font-size: 0.85rem"></p>
        </form>
      </div>
    </div>

    <script type="module">
      import { auth } from './firebase-init.js'
      import { initAuthListener, logout } from './auth.js'
      import { getCategories, createTopic } from './community.js'
      import { validateImageFile, createImagePreview } from './utils.js'

      const form = document.getElementById('create-topic-form')
      const categorySelect = document.getElementById('category-select')
      const imageInput = document.getElementById('image-input')
      const imagePreviewContainer = document.getElementById('image-preview-container')
      const imagePreviews = document.getElementById('image-previews')
      const errorMsg = document.getElementById('error-msg')
      const submitBtn = document.getElementById('submit-btn')
      const logoutBtn = document.getElementById('logout-btn')

      let selectedImages = []

      // Check auth
      initAuthListener((user) => {
        if (!user) {
          window.location.href = 'signin.html'
        } else if (!user.emailVerified) {
          window.location.href = 'verify-email.html'
        } else {
          loadCategories()
        }
      })

      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => logout())
      }

      async function loadCategories() {
        try {
          // Reset to just the first placeholder option.
          // (Fixes the duplicated "select a category..." look when you re-enter the page.)
          while (categorySelect.options.length > 1) categorySelect.remove(1)

          const fallback = [
            { id: 'linux', title: 'linux' },
            { id: 'programming', title: 'programming' },
            { id: 'tech', title: 'tech' }
          ]

          // Pull from Firestore, but if empty we still show the 3 required categories.
          const categories = await getCategories()
          const list = categories && categories.length ? categories : fallback

          // Add "no category" option (explicit value, not empty).
          const noCategoryOption = document.createElement('option')
          noCategoryOption.value = 'uncategorized'
          noCategoryOption.textContent = 'no category'
          categorySelect.appendChild(noCategoryOption)

          // Add separator for readability
          const separator = document.createElement('option')
          separator.disabled = true
          separator.textContent = '──────────'
          categorySelect.appendChild(separator)

          // Add categories
          list.forEach((category) => {
            const option = document.createElement('option')
            option.value = category.id
            option.textContent = category.title
            categorySelect.appendChild(option)
          })
        } catch (error) {
          console.error('Error loading categories:', error)
          errorMsg.textContent = 'failed to load categories. please refresh.'
          errorMsg.style.display = 'block'
        }
      }

      imageInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files)
        selectedImages = []
        imagePreviews.innerHTML = ''

        files.forEach((file, index) => {
          const validation = validateImageFile(file)
          if (!validation.valid) {
            errorMsg.textContent = validation.error
            errorMsg.style.display = 'block'
            return
          }

          selectedImages.push(file)
          createImagePreview(file, (previewUrl) => {
            if (previewUrl) {
              const div = document.createElement('div')
              div.style.position = 'relative'
              div.style.width = '150px'
              div.style.height = '150px'
              div.style.borderRadius = '4px'
              div.style.overflow = 'hidden'
              div.style.border = '1px solid var(--clr-gray-dark)'
              div.innerHTML = `
                            <img src="${previewUrl}" style="width:100%; height:100%; object-fit:cover;">
                            <button type="button" class="remove-image-btn" data-index="${index}" style="position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.7); color:white; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer; font-size:14px;">×</button>
                        `
              imagePreviews.appendChild(div)

              div.querySelector('.remove-image-btn').addEventListener('click', () => {
                selectedImages = selectedImages.filter((_, i) => i !== index)
                div.remove()
                if (selectedImages.length === 0) {
                  imagePreviewContainer.style.display = 'none'
                }
              })
            }
          })
        })

        if (selectedImages.length > 0) {
          imagePreviewContainer.style.display = 'block'
        }
      })

      form.addEventListener('submit', async (e) => {
        e.preventDefault()
        errorMsg.style.display = 'none'

        const categoryId = categorySelect.value
        const title = document.getElementById('topic-title').value.trim()
        const content = document.getElementById('post-content').value.trim()

        if (!categoryId) {
          errorMsg.textContent = 'pick a category (or choose "no category").'
          errorMsg.style.display = 'block'
          return
        }

        if (!title || title.length < 3) {
          errorMsg.textContent = 'title must be at least 3 characters.'
          errorMsg.style.display = 'block'
          return
        }

        if (!content || content.length < 10) {
          errorMsg.textContent = 'post content must be at least 10 characters.'
          errorMsg.style.display = 'block'
          return
        }

        submitBtn.textContent = 'creating...'
        submitBtn.disabled = true

        try {
          const topicId = await createTopic(categoryId, title, content, selectedImages)
          window.location.href = `topic.html?id=${topicId}`
        } catch (error) {
          console.error('Error creating topic:', error)
          errorMsg.textContent = 'failed to create topic. please try again.'
          errorMsg.style.display = 'block'
          submitBtn.textContent = 'create topic'
          submitBtn.disabled = false
        }
      })
    </script>
    <footer class="footer">
      <div class="footer-content">
        <div class="footer-brand">
          <div class="logo-text"><span>I</span>nfiniware</div>
          <p class="text-dim" style="max-width: 250px; font-size: 0.85rem">
            an independent ecosystem building tools with intention and structural focus.
          </p>
        </div>
        <div class="footer-links">
          <div class="footer-col">
            <h4>platform</h4>
            <div class="footer-item">
              <a href="manifesto.html" class="footer-link">manifesto</a>
            </div>
            <div class="footer-item">
              <a href="faq.html" class="footer-link">faq</a>
            </div>
            <div class="footer-item">
              <a href="dashboard.html" class="footer-link">community hub</a>
            </div>
          </div>
          <div class="footer-col">
            <h4>legal</h4>
            <div class="footer-item">
              <a href="privacy.html" class="footer-link">privacy policy</a>
            </div>
            <div class="footer-item">
              <a href="license.html" class="footer-link">license</a>
            </div>
          </div>
          <div class="footer-col">
            <h4>support</h4>
            <div class="footer-item">
              <a href="mailto:support@infiniware.bid" class="footer-link">support@infiniware.bid</a>
            </div>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <span>infiniware © 2026</span>
        <span>crafted by human hand</span>
      </div>
    </footer>

    <script type="module" src="script.js"></script>
  </body>
</html>
